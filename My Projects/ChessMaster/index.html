<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChessMaster</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    
    <style>
        * { box-sizing: border-box; }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background-color: #1e1e24; 
            color: white;
            margin: 0; 
            padding: 10px;
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
        }
        
        h1 { color: #facc15; margin: 0 0 10px 0; font-size: 24px; text-align: center; flex-shrink: 0; }

        .container { 
            display: flex; 
            gap: 20px; 
            align-items: flex-start; 
            width: 100%; 
            max-width: 900px; 
            flex: 1; 
            overflow: hidden; 
            justify-content: center;
        }

        .board-area { 
            display: flex; 
            flex-direction: column; 
            width: 450px; 
            flex-shrink: 0;
        }

        .panel { 
            background: #2b2b36; 
            padding: 15px; 
            border-radius: 10px; 
            box-shadow: 0px 4px 10px rgba(0,0,0,0.5);
            width: 320px;
            display: flex; 
            flex-direction: column;
            height: auto;
        }
        
        select, button { 
            width: 100%; 
            padding: 10px; 
            border-radius: 5px; 
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
        }
        select { background: #fff; color: #333; }
        
        button.start-btn { background: #4CAF50; color: white; font-weight: bold; }
        button.undo-btn { background: #e91e63; color: white; font-weight: bold; } 
        button.resign-btn { background: #f44336; color: white; font-weight: bold; }
        button.analyze-btn { background: #ff9800; color: white; font-weight: bold; }
        button.hint-btn { background: #008CBA; color: white; font-weight: bold; margin-top: 5px;}
        
        button:hover { opacity: 0.8; transform: scale(0.98); }
        button:disabled { background: #666; cursor: not-allowed; transform: none; }
        
        .status { margin-bottom: 15px; font-size: 18px; font-weight: bold; color: #ffeb3b; text-align: center; flex-shrink: 0; }
        #hintDisplay { margin-top: 2px; font-size: 13px; color: #00ffff; min-height: 18px; text-align: center; }
        
        .player-label { font-size: 12px; color: #aaa; margin-bottom: 2px; }
        
        .captured-box {
            background: #333440;
            padding: 6px 8px;
            border-radius: 5px;
            font-size: 22px; 
            min-height: 32px;
            display: flex;         
            flex-wrap: wrap;       
            gap: 4px;              
        }
        .margin-bottom { margin-bottom: 8px; }
        .margin-top { margin-top: 8px; }
        
        .panel-controls { display: flex; gap: 8px; margin-bottom: 15px; flex-shrink: 0; }
        
        .panel-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex-shrink: 0;
        }
        .panel-buttons button { flex: 1 1 45%; }

        /* --- EXTREME MOBILE OPTIMIZATION --- */
        @media (max-width: 800px) {
            body { padding: 2px; padding-bottom: 5px; justify-content: flex-start; }
            h1 { margin: 0; font-size: 18px; padding-bottom: 2px; }
            
            .container { flex-direction: column; align-items: center; gap: 4px; }
            
            .board-area { width: 100%; max-width: min(100vw - 4px, 53vh); align-items: center; }
            #myBoard { width: 100%; }
            
            .player-label { margin-bottom: 0; font-size: 11px; }
            .captured-box { width: 100%; font-size: 15px; min-height: 22px; padding: 1px 4px; gap: 1px; }
            .margin-top { margin-top: 3px; }
            .margin-bottom { margin-bottom: 3px; }
            #hintBtn { width: 100%; padding: 6px; margin-top: 3px; font-size: 12px; }
            #hintDisplay { margin-top: 0; min-height: 14px; font-size: 11px; }
            
            .panel { width: 100%; max-width: min(100vw - 4px, 53vh); padding: 6px 10px; margin-top: 0; }
            
            select, button { padding: 6px; font-size: 13px; }
            
            .status { font-size: 14px; margin-bottom: 4px; }
            
            .panel-controls { display: flex; flex-direction: row; gap: 4px; margin-bottom: 6px; }
            .panel-controls select { flex: 1; margin: 0; }
            
            .panel-buttons { gap: 4px; }
            .panel-buttons button { flex: 1 1 45%; padding: 6px 2px; font-size: 12px; }
        }

        .highlight-square { background-color: rgba(235, 225, 50, 0.7) !important; }
        .selected-square { background-color: rgba(60, 180, 60, 0.7) !important; }
        .hint-square { 
            background-color: rgba(0, 255, 255, 0.5) !important; 
            box-shadow: inset 0 0 15px rgba(0, 255, 255, 0.8);
            cursor: pointer !important; 
        }

        .warning-text { color: #ff4c4c !important; animation: shake 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .legal-move-dot { position: relative; cursor: pointer; }
        .legal-move-dot::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 25%; height: 25%;
            background-color: rgba(0, 0, 0, 0.4); border-radius: 50%;
            z-index: 10; pointer-events: none;
        }

        .legal-capture { position: relative; cursor: pointer; }
        .legal-capture::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            margin: auto; width: 85%; height: 85%; border-radius: 50%;
            border: 6px solid rgba(0, 0, 0, 0.3); z-index: 10; pointer-events: none;
            box-sizing: border-box;
        }

        /* --- STOP IMAGE DOWNLOAD/LONG PRESS --- */
        #myBoard img {
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            user-select: none !important;
            pointer-events: none !important; 
        }

        /* Modals & Overlays */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center;
        }
        .custom-modal {
            background: #2b2b36; padding: 20px; border-radius: 12px; text-align: center; 
            box-shadow: 0px 10px 30px rgba(0,0,0,0.8); border: 2px solid #444; max-width: 320px; margin: 0 10px;
        }
        .custom-modal h2 { margin-top: 0; color: #facc15; font-size: 20px;}
        .promo-options { display: flex; justify-content: space-around; margin-top: 15px; }
        .promo-piece { 
            width: 60px; height: 60px; cursor: pointer; transition: 0.2s; 
            background: rgba(255,255,255,0.1); border-radius: 10px; padding: 5px;
        }
        .promo-piece:hover { transform: scale(1.1); background: rgba(255,255,255,0.3); }

        /* Full Screen Analysis Overlay */
        .analysis-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30,30,36,0.98); z-index: 2000; flex-direction: column;
            padding: 15px; overflow-y: auto; color: white;
        }
        .analysis-overlay h2 { color: #ff9800; text-align: center; margin-bottom: 15px; font-size: 22px;}
        .analysis-content { 
            max-width: 600px; margin: 0 auto; width: 100%; 
            font-family: monospace; font-size: 14px; line-height: 1.5;
            background: #1a1a20; padding: 12px; border-radius: 8px;
        }
        .close-btn-container { max-width: 600px; margin: 15px auto 30px auto; width: 100%; text-align: center; }

        .confetti {
            position: fixed; width: 10px; height: 10px; background: #facc15;
            animation: fall linear forwards; top: -10px; z-index: 999;
        }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }
    </style>
</head>
<body>

    <h1>ChessMaster</h1>
    
    <div class="container">
        <div class="board-area">
            <div id="topPlayerLabel" class="player-label" style="width: 100%;">Computer Captured:</div>
            <div id="topCaptured" class="captured-box margin-bottom"></div>
            
            <div id="myBoard" oncontextmenu="return false;"></div>
            
            <div id="bottomPlayerLabel" class="player-label margin-top" style="width: 100%;">You Captured:</div>
            <div id="bottomCaptured" class="captured-box margin-bottom"></div>

            <button class="hint-btn" id="hintBtn" onclick="getHint()">üí° Get Hint</button>
            <div id="hintDisplay"></div>
        </div>
        
        <div class="panel">
            <div class="status" id="status">White to move</div>
            
            <div class="panel-controls">
                <select id="colorSelect">
                    <option value="w">Play White</option>
                    <option value="b">Play Black</option>
                </select>
                <select id="difficultySelect">
                    <option value="2">Level: Easy</option>
                    <option value="5">Level: Medium</option>
                    <option value="10" selected>Level: Hard</option>
                    <option value="15">Level: Expert</option>
                </select>
            </div>

            <div class="panel-buttons">
                <button class="start-btn" onclick="startGame()">Restart</button>
                <button class="undo-btn" onclick="undoMove()">Undo</button>
                <button class="resign-btn" onclick="resignGame()">Resign</button>
                <button class="analyze-btn" onclick="toggleAnalysis()">Analyze</button>
            </div>
        </div>
    </div>

    <div id="promotionModal" class="modal-overlay">
        <div class="custom-modal">
            <h2>Pawn Promotion</h2>
            <p style="color:#aaa; font-size:14px;">Choose your piece:</p>
            <div id="promoImagesContainer" class="promo-options"></div>
        </div>
    </div>

    <div id="gameOverModal" class="modal-overlay">
        <div class="custom-modal">
            <h2 id="gameOverTitle">Game Over!</h2>
            <p id="gameOverMessage" style="font-size: 16px; margin: 15px 0;"></p>
            <div style="display:flex; gap:10px; justify-content: center;">
                <button onclick="closeGameOverModal(); startGame();" style="background:#4CAF50; color:white; padding: 10px;">Play Again</button>
                <button onclick="closeGameOverModal();" style="background:#666; color:white; padding: 10px;">Close</button>
            </div>
        </div>
    </div>

    <div id="resignModal" class="modal-overlay">
        <div class="custom-modal">
            <h2>Resign Game?</h2>
            <p style="font-size: 16px; margin: 15px 0; color: #ddd;">Are you sure you want to resign?</p>
            <div style="display:flex; gap:10px; justify-content: center;">
                <button onclick="confirmResign();" style="background:#f44336; color:white; padding: 10px;">Yes, Resign</button>
                <button onclick="cancelResign();" style="background:#666; color:white; padding: 10px;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="analysisOverlay" class="analysis-overlay">
        <h2>üìä Game Analysis</h2>
        <div id="analysisContent" class="analysis-content"></div>
        <div class="close-btn-container">
            <button class="analyze-btn" style="padding: 12px; font-size: 16px;" onclick="toggleAnalysis()">‚ùå Close Analysis</button>
        </div>
    </div>

    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        var game = new Chess();
        var board = null;
        var playerColor = 'w'; 
        var isComputerThinking = false;
        var selectedSquare = null; 
        var pendingPromotionMove = null; 
        var activeHintMove = null; 
        
        var moveSound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3');
        var captureSound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3');
        var checkSound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-check.mp3');

        var blackPieceSymbols = { 'p': '‚ôü', 'n': '‚ôû', 'b': '‚ôù', 'r': '‚ôú', 'q': '‚ôõ' };
        var whitePieceSymbols = { 'p': '‚ôô', 'n': '‚ôò', 'b': '‚ôó', 'r': '‚ôñ', 'q': '‚ôï' };

        const CHESS_API_URL = 'https://chess-api.com/v1';

        function playSound() {
            if (game.in_check() || game.in_checkmate()) { checkSound.play(); } 
            else { moveSound.play(); } 
        }

        function clearHintHighlights() {
            $('#myBoard .square-55d63').removeClass('hint-square');
            activeHintMove = null; 
        }

        function removeHighlights() {
            $('#myBoard .square-55d63').removeClass('highlight-square');
        }

        function highlightLastMove() {
            removeHighlights();
            var history = game.history({ verbose: true });
            if (history.length > 0) {
                var lastMove = history[history.length - 1];
                $('#myBoard .square-' + lastMove.from).addClass('highlight-square');
                $('#myBoard .square-' + lastMove.to).addClass('highlight-square');
            }
        }

        function clearSelection() {
            selectedSquare = null;
            $('#myBoard .square-55d63').removeClass('selected-square legal-move-dot legal-capture');
        }

        function showLegalMoves(square) {
            clearSelection(); 
            selectedSquare = square;
            $('#myBoard .square-' + square).addClass('selected-square');
            
            var moves = game.moves({ square: square, verbose: true });
            moves.forEach(function(m) {
                if (m.flags.includes('c') || m.flags.includes('e')) {
                    $('#myBoard .square-' + m.to).addClass('legal-capture');
                } else {
                    $('#myBoard .square-' + m.to).addClass('legal-move-dot');
                }
            });
        }

        $('#myBoard').on('click', '.square-55d63', function() {
            var square = $(this).attr('data-square');
            if (square) {
                handleSquareClick(square);
            }
        });

        function handleSquareClick(square) {
            if (game.game_over() || isComputerThinking || pendingPromotionMove) return;

            if (activeHintMove) {
                if (square === activeHintMove.to || square === activeHintMove.from) {
                    var moveCompleted = attemptMove(activeHintMove.from, activeHintMove.to);
                    if (moveCompleted === null && pendingPromotionMove) { clearSelection(); return; }
                    if (moveCompleted) { clearSelection(); return; }
                } else {
                    clearHintHighlights(); 
                }
            }

            var piece = game.get(square);

            if (selectedSquare) {
                if (selectedSquare === square) {
                    clearSelection();
                    return;
                }

                var moves = game.moves({ square: selectedSquare, verbose: true });
                var isLegalMove = moves.find(m => m.to === square);

                if (isLegalMove) {
                    var moveCompleted = attemptMove(selectedSquare, square);
                    if (moveCompleted === null && pendingPromotionMove) { clearSelection(); return; }
                    if (moveCompleted) { clearSelection(); return; }
                }

                if (piece && piece.color === playerColor) {
                    showLegalMoves(square);
                    return;
                }

                clearSelection();
            } else {
                if (piece && piece.color === playerColor) {
                    showLegalMoves(square);
                }
            }
        }

        // --- NEW STRICT WIN/LOSS/DRAW LOGIC ---
        function updateStatus() {
            var statusHTML = '';
            var moveColor = game.turn() === 'w' ? 'White' : 'Black';

            $('#status').removeClass('warning-text');

            if (game.in_checkmate()) {
                var humanColorName = playerColor === 'w' ? 'White' : 'Black';
                var winnerColor = game.turn() === 'w' ? 'Black' : 'White'; // Jiska turn hai, vo haar gaya
                
                var isHumanWinner = (winnerColor === humanColorName);

                if (isHumanWinner) {
                    statusHTML = 'Checkmate! You won! üéâ';
                    triggerGameOverModal('win');
                } else {
                    statusHTML = 'Checkmate! You lost. üò¢';
                    triggerGameOverModal('loss');
                }
            } else if (game.in_draw()) {
                statusHTML = 'Game Over! Draw. ü§ù';
                triggerGameOverModal('draw');
            } else {
                statusHTML = moveColor + ' to move';
                if (game.in_check()) statusHTML += ' (CHECK!)';
            }
            $('#status').html(statusHTML);
        }

        function triggerGameOverModal(result, byResignation) {
            setTimeout(function() {
                var title, msg;
                
                if (result === 'win') {
                    title = "Congratulations! üéâüèÜ";
                    msg = "You won the game! Brilliant play!";
                    throwConfetti();
                } else if (result === 'loss') {
                    title = "Game Over! üò¢";
                    msg = byResignation ? "You resigned. The computer wins." : "Checkmate! The computer wins. Better luck next time.";
                } else {
                    title = "It's a Draw! ü§ù";
                    msg = "The game ended in a tie.";
                }
                
                $('#gameOverTitle').text(title);
                $('#gameOverMessage').text(msg);
                $('#gameOverModal').css('display', 'flex');
            }, 500); 
        }

        function closeGameOverModal() {
            $('#gameOverModal').hide();
            $('.confetti').remove(); 
        }

        function throwConfetti() {
            for(var i=0; i<60; i++) {
                var colors = ['#facc15', '#ff4c4c', '#4CAF50', '#008CBA', '#e91e63'];
                var color = colors[Math.floor(Math.random() * colors.length)];
                var left = Math.random() * 100 + 'vw';
                var animDuration = (Math.random() * 2 + 2) + 's';
                var delay = Math.random() * 1 + 's';
                var div = $('<div class="confetti"></div>').css({
                    'left': left,
                    'background-color': color,
                    'animation-duration': animDuration,
                    'animation-delay': delay
                });
                $('body').append(div);
            }
        }

        function startGame() {
            playerColor = $('#colorSelect').val();
            
            game.reset();
            board.orientation(playerColor === 'w' ? 'white' : 'black');
            board.position('start');
            
            $('#hintDisplay').text('');
            clearHintHighlights(); 
            closeGameOverModal();
            $('#resignModal').hide();
            $('#analysisOverlay').hide();
            
            isComputerThinking = false;
            pendingPromotionMove = null;
            
            if(playerColor === 'w') {
                $('#topPlayerLabel').text('Computer (Black) Captured:');
                $('#bottomPlayerLabel').text('You (White) Captured:');
            } else {
                $('#topPlayerLabel').text('Computer (White) Captured:');
                $('#bottomPlayerLabel').text('You (Black) Captured:');
            }
            
            refreshCapturedPieces();
            updateStatus();
            removeHighlights(); 
            clearSelection();

            if (playerColor === 'b') { window.setTimeout(makeComputerMove, 250); }
        }

        function resignGame() {
            if(game.game_over() || isComputerThinking || $('#status').text().includes('resigned')) return;
            $('#resignModal').css('display', 'flex');
        }

        function cancelResign() {
            $('#resignModal').hide();
        }

        function confirmResign() {
            $('#resignModal').hide(); 
            
            $('#status').text('You resigned. Computer wins!');
            triggerGameOverModal('loss', true); // Custom pass for loss by resignation
            
            game.set_turn = "game_over"; 
        }

        function refreshCapturedPieces() {
            $('#topCaptured').html('');
            $('#bottomCaptured').html('');
            
            var history = game.history({ verbose: true });
            for (var i = 0; i < history.length; i++) {
                var move = history[i];
                if (move.captured) {
                    var isCapturedPieceWhite = (move.color === 'b'); 
                    var pieceSymbol = isCapturedPieceWhite ? whitePieceSymbols[move.captured] : blackPieceSymbols[move.captured];
                    var cssClass = isCapturedPieceWhite ? 'white-captures' : 'black-captures';
                    var span = '<span class="' + cssClass + '">' + pieceSymbol + '</span>';

                    if (move.color === playerColor) {
                        $('#bottomCaptured').append(span); 
                    } else {
                        $('#topCaptured').append(span); 
                    }
                }
            }
        }

        function handlePostMove(move) {
            if (move.captured) { captureSound.play(); } else { playSound(); }
            refreshCapturedPieces(); 
            clearHintHighlights(); 
            highlightLastMove();  
        }

        function undoMove() {
            if (isComputerThinking || pendingPromotionMove || game.game_over()) return;

            var history = game.history();
            if (history.length === 0) return; 

            if (history.length === 1 && playerColor === 'b') { game.undo(); } 
            else if (history.length >= 2) { game.undo(); game.undo(); } 
            else { game.undo(); }

            board.position(game.fen()); 
            updateStatus();
            refreshCapturedPieces(); 
            $('#hintDisplay').text(''); 
            clearSelection();
            clearHintHighlights(); 
            highlightLastMove(); 
        }

        function attemptMove(source, target) {
            var pieceDetails = game.get(source);
            var isPromotion = pieceDetails && pieceDetails.type === 'p' && 
                              ((pieceDetails.color === 'w' && target.charAt(1) === '8') || 
                               (pieceDetails.color === 'b' && target.charAt(1) === '1'));
            
            if (isPromotion) {
                pendingPromotionMove = { from: source, to: target };
                var pColor = pieceDetails.color;
                var html = `
                    <img src="https://chessboardjs.com/img/chesspieces/wikipedia/${pColor}Q.png" class="promo-piece" onclick="finalizePromotion('q')">
                    <img src="https://chessboardjs.com/img/chesspieces/wikipedia/${pColor}R.png" class="promo-piece" onclick="finalizePromotion('r')">
                    <img src="https://chessboardjs.com/img/chesspieces/wikipedia/${pColor}B.png" class="promo-piece" onclick="finalizePromotion('b')">
                    <img src="https://chessboardjs.com/img/chesspieces/wikipedia/${pColor}N.png" class="promo-piece" onclick="finalizePromotion('n')">
                `;
                $('#promoImagesContainer').html(html);
                $('#promotionModal').css('display', 'flex');
                return null; 
            }

            var move = game.move({ from: source, to: target, promotion: 'q' });
            
            if (move === null) {
                $('#status').addClass('warning-text').text("Illegal Move! Try again.");
                setTimeout(updateStatus, 1500); 
                return null;
            }
            
            board.position(game.fen());
            $('#hintDisplay').text(''); 
            handlePostMove(move);
            updateStatus();
            
            makeComputerMove();
            return move;
        }

        function finalizePromotion(choice) {
            $('#promotionModal').hide();
            if (!pendingPromotionMove) return;
            
            var move = game.move({ 
                from: pendingPromotionMove.from, 
                to: pendingPromotionMove.to, 
                promotion: choice 
            });
            
            pendingPromotionMove = null;
            
            if (move === null) {
                $('#status').addClass('warning-text').text("Illegal Move! Try again.");
                setTimeout(updateStatus, 1500); 
                return;
            }
            
            board.position(game.fen()); 
            $('#hintDisplay').text(''); 
            handlePostMove(move);
            updateStatus();
            makeComputerMove(); 
        }

        async function fetchStockfishMove(fenStr, depthVal) {
            try {
                const response = await fetch(CHESS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fen: fenStr, depth: parseInt(depthVal) })
                });
                const data = await response.json();
                return data.san; 
            } catch (error) {
                console.error("API Error:", error);
                return null;
            }
        }

        async function makeComputerMove() {
            if (game.game_over() || $('#status').text().includes('resigned')) return;
            
            isComputerThinking = true; 
            $('#status').text('Computer is thinking... üß†');
            
            var currentDepth = $('#difficultySelect').val();
            var bestMove = await fetchStockfishMove(game.fen(), currentDepth);

            if (!bestMove) {
                var possibleMoves = game.moves();
                bestMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
            }
            
            var moveObj = game.move(bestMove);
            handlePostMove(moveObj);
            
            board.position(game.fen());
            isComputerThinking = false; 
            updateStatus();
        }

        async function getHint() {
            if (game.game_over() || game.turn() !== playerColor || isComputerThinking || pendingPromotionMove) return;
            
            var $hintBtn = $('#hintBtn');
            $hintBtn.prop('disabled', true).text('Thinking...');
            $('#hintDisplay').text('Asking Stockfish...');
            clearHintHighlights(); 

            var hintMove = await fetchStockfishMove(game.fen(), 10);
            
            if(hintMove) {
                $('#hintDisplay').text('Hint: Try playing ' + hintMove);
                
                var moves = game.moves({ verbose: true });
                var hintObj = moves.find(m => m.san === hintMove);
                
                if (hintObj) {
                    $('#myBoard .square-' + hintObj.from).addClass('hint-square');
                    $('#myBoard .square-' + hintObj.to).addClass('hint-square');
                    activeHintMove = hintObj; 
                }
            } else {
                $('#hintDisplay').text('Hint: Cannot connect to server.');
            }
            
            $hintBtn.prop('disabled', false).text('üí° Get Hint');
        }

        function toggleAnalysis() {
            var $overlay = $('#analysisOverlay');
            if ($overlay.is(':visible')) {
                $overlay.fadeOut(200);
            } else {
                var pgn = game.pgn() || "No moves played yet.";
                var htmlContent = "<div style='color:#facc15; margin-bottom:10px;'><b>Complete PGN:</b></div>";
                htmlContent += "<div style='background:#111; padding:10px; border-radius:5px; margin-bottom:20px; word-wrap:break-word;'>" + pgn + "</div>";
                
                var history = game.history();
                if (history.length > 0) {
                    htmlContent += "<div style='color:#facc15; margin-bottom:10px;'><b>Move-by-Move List:</b></div>";
                    htmlContent += "<table style='width:100%; border-collapse:collapse; text-align:left;'>";
                    
                    for (var i = 0; i < history.length; i += 2) {
                        var moveNum = (i / 2) + 1;
                        var moveW = history[i];
                        var moveB = history[i+1] ? history[i+1] : '';
                        
                        var bg = (moveNum % 2 === 0) ? "background:rgba(255,255,255,0.02);" : "";
                        htmlContent += "<tr style='" + bg + " border-bottom:1px solid #333;'>";
                        htmlContent += "<td style='padding:5px; color:#888; width:40px;'>" + moveNum + ".</td>";
                        htmlContent += "<td style='padding:5px;'>" + moveW + "</td>";
                        htmlContent += "<td style='padding:5px;'>" + moveB + "</td>";
                        htmlContent += "</tr>";
                    }
                    htmlContent += "</table>";
                }
                
                $('#analysisContent').html(htmlContent);
                $overlay.css('display', 'flex').hide().fadeIn(200);
            }
        }

        var config = {
            draggable: false, 
            position: 'start',
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };

        board = Chessboard('myBoard', config);
        
        $(window).resize(function() { board.resize(); });
        
        updateStatus();
    </script>

</body>
</html>